var numContainers,order=[],containerOrder=[],currContainer=0,thumbExpand=300,expandSpeed=0.25,zIndexTop=100,storyCount=-1,timer,maskCount=0,canvasWidth,canvasHeight,navPos=548;function preLoadImages(){var a=[];$.each(allData.stories,function(b,c){$.each(allData.stories[b].thumb,function(d,e){a.push(allData.stories[b].thumb[d].img)})});imageCache.pushArray(a,imageLoaded,allImagesLoaded)}function allImagesLoaded(){canvasWidth=$(".viewport").width();canvasHeight=$(".viewport").height();initContainers(allData.structure);initStories(allData.stories);$(".loading").fadeOut(function(){$(this).remove()});trackEvent()}function initContainers(b){var a=getRandom(0,b.length-1);$.each(b[a].containers.container,function(e,d){var c=$("<div/>",{css:{left:d.left,top:d.top,width:d.width,height:d.height},data:{height:d.height,width:d.width,left:d.left,top:d.top},"class":"story story"+e});numContainers=b[a].containers.container.length;c.appendTo(".viewport")})}function initStories(c){order=randomiseArray(c.length);var b=0;for(var a=0;a<=numContainers;a++){createNewStory(a,order[a],function(e){b++;e="";if(b==numContainers){containerOrder=randomiseArray(numContainers);var g=new TimelineMax({onComplete:initialiseTimer});for(var d=0;d<numContainers;d++){var f=$(".story"+containerOrder[d]+" .img-crop");var h=(Math.floor(Math.random()*6+3))/10;g.add(TweenMax.to(f,h,{left:f.data("left"),top:f.data("top"),ease:Circ.easeOut}),"-=.3")}$(".story").mouseenter(function(){var r=$(this);var p=r.find(".img-crop");var t=thumbExpand;var j=thumbExpand;var m=thumbExpand;var s=thumbExpand;var n=r.position();var o;var k;if(r.width()>r.height()){t=Math.floor((thumbExpand/r.width())*r.height());m=Math.floor((thumbExpand/p.width())*p.height())}else{j=Math.floor((thumbExpand/r.height())*r.width());s=Math.floor((thumbExpand/p.height())*p.width())}var l=Math.floor((j-r.width())/2);var i=Math.floor((t-r.height())/2);r.addClass("current");$(".viewport .story:not(.current)").addClass("effect");o=n.top-i;if(o<0){o=0}if(o+t>navPos){o=navPos-t}k=n.left-l;if(k+j>canvasWidth){k=canvasWidth-j}if(k<0){k=0}var q=new TimelineMax();q.add(TweenMax.to(r,expandSpeed,{width:j,height:t,left:k,top:o,ease:Circ.easeOut}));q.add(TweenMax.to(p,expandSpeed,{width:s,height:m,ease:Circ.easeOut}),"-=.25");q.play();bringToFront(r);r.find(".content .cta").show();r.find(".content").delay(250).slideDown();pauseTimer()}).mouseleave(function(){var k=$(this);var j=k.find(".img-crop");var i=new TimelineMax();i.add(TweenMax.to(k,expandSpeed,{width:k.data("width"),height:k.data("height"),left:k.data("left"),top:k.data("top"),ease:Circ.easeOut}));i.add(TweenMax.to(j,expandSpeed,{width:j.data("width"),height:j.data("height"),left:j.data("left"),top:j.data("top"),ease:Circ.easeOut}),"-=.25");i.play();k.find("img").removeClass("over");k.find(".content .cta").hide();k.find(".content").stop(true,false).slideUp();k.removeClass("current");$(".viewport .story").removeClass("effect");initialiseTimer()}).click(function(){var n=$(this);var o=n.position();var i=n.find(".content").data("color");var l=$("<div/>",{css:{left:o.left,top:o.top,width:n.width(),height:n.height()},"class":"transition bg-"+color[i]});var k=function(){$(".transition").remove()};var j=new TweenMax.to(l,0.5,{top:0,left:0,width:canvasWidth,height:canvasHeight,autoAlpha:1,ease:Quad.easeIn,onComplete:loadStory,onCompleteParams:[n.data("id"),i],onReverseComplete:k});var m=$("<div/>",{"class":"closecontent"}).click(function(){$(".transition .story-detail").remove();initContainers(allData.structure);initStories(allData.stories);m.hide();j.reverse();initialiseTimer()});m.appendTo(l);$(".viewport").append(l);m.show();pauseTimer()})}})}}function loadStory(i,k){$(".story").remove();var g=$("<div/>",{"class":"story-detail"});var l=$("<img/>",{"class":"bg",css:{position:"absolute",visibility:"hidden"}}).appendTo(g);var q=$("<div/>",{"class":"story-copy"});var s=$("<header/>",{"class":"bg-"+color[k]}).appendTo(q);var c=$("<span>",{text:"("+allData.stories[i].subline+")"});var f=$("<h1>",{text:allData.stories[i].title}).append(c);var e=$("<h2>",{text:allData.stories[i].summary});var n=$("<article/>");var d=$("<h3>",{text:allData.stories[i].leadline});var p=$("<div/>",{html:allData.stories[i].copy});var r=$("<div/>",{"class":"play"});var j=$("<div/>",{"class":"floating-circles",html:'<div class="f_circleG" id="frotateG_01"></div><div class="f_circleG" id="frotateG_02"></div><div class="f_circleG" id="frotateG_03"></div><div class="f_circleG" id="frotateG_04"></div><div class="f_circleG" id="frotateG_05"></div><div class="f_circleG" id="frotateG_06"></div><div class="f_circleG" id="frotateG_07"></div><div class="f_circleG" id="frotateG_08"></div>'});var b=$("<div/>",{"class":"player-overlay"}).append(r).append(j);var h=$("<div/>",{"class":"player"});f.appendTo(s).after(e);n.append(d).append(p).appendTo(q);q.appendTo(g);h.appendTo(g);b.appendTo(g);$(".transition").append(g);initVideo(i);loadImageGallery(i,k);trackEvent(allData.stories[i].trackingtitle);var a=function(){$(".transition").removeClass(function(t,u){return(u.match(/\bbg-\S+/g)||[]).join(" ")}).addClass("bg-"+color[k])};l.load(function(){TweenMax.to($(".transition .bg"),2,{css:{autoAlpha:1},onComplete:a})}).attr("src",allData.stories[i].img);$(".story-copy").slideDown(1000);TweenMax.to($(".player-overlay"),1,{delay:1,css:{autoAlpha:1}});var o=$("<a/>",{href:"#","class":"next story-nav",text:"Next",css:{visibility:"hidden"}}).click(function(){pos=order.indexOf(i);i=pos>=allData.stories.length-1?order[0]:order[pos+1];storyNavigation(canvasWidth*-1,i);return false}).appendTo(g);var m=$("<a/>",{href:"#","class":"prev story-nav",text:"Previous",css:{visibility:"hidden"}}).click(function(){pos=order.indexOf(i);i=pos==0?order[order.length-1]:order[pos-1];storyNavigation(canvasWidth,i);return false}).appendTo(g);TweenMax.to($(".story-nav"),2,{css:{autoAlpha:1}})}function storyNavigation(a,c){$(".story-nav").remove();var b=function(){$(".story-detail").remove();loadStory(c,getRandom(0,color.length-1))};TweenMax.to($(".story-detail"),0.75,{left:a,ease:Quad.easeOut,onComplete:b,onCompleteParams:[c]})}function initVideo(a){$(".player-overlay").click(function(){$(".play").hide();$(".floating-circles").fadeIn();$(".player").brightcoveVideo({playerID:allData.stories[a].BrightcovePlayerID,"@videoPlayer":allData.stories[a].BrightcoveVideoPlayer,templateReadyHandler:onBrightcoveTemplateReady})})}function onBrightcoveTemplateReady(a){$(".player-overlay").hide(function(){$(".play").show();$(".floating-circles").hide()});var b=$(this);b.brightcoveVideo("play");fadeBackground(false);b.brightcoveVideo("onMediaEvent","COMPLETE",function(c){b.brightcoveVideo("destroy");fadeBackground(true);$(".player-overlay").fadeIn()});b.brightcoveVideo("onMediaEvent","PLAY",function(c){fadeBackground(false)});b.brightcoveVideo("onMediaEvent","STOP",function(c){fadeBackground(true)});$("#destroy").click(function(){fadeBackground(false);$(".player").fadeIn();b.brightcoveVideo("destroy")});trackEvent(allData.stories[id].trackingtitle+"/video")}function fadeBackground(a){var b=(a)?1:0.5;TweenMax.to($(".transition .bg"),0.5,{css:{autoAlpha:b}})}function loadImageGallery(b,a){$.each(allData.stories[b].gallery,function(k,n){var g=130;var m=410;var l=500;var e;var i=0;var c=$("<img/>",{"class":"gallery-item",css:{visibility:"hidden"}}).appendTo($(".story-detail"));if(this.caption!=undefined){var f=$("<div/>",{"class":"caption bg-"+color[a],html:"<span>"+this.caption+"</span>"})}var d=function(y){var u=y.position();var q=y.width();var w=y.height()-2;var x=l;var o=l;if(q>w){x=Math.floor((l/q)*w)}else{o=Math.floor((l/w)*q)}var s=Math.floor((o-q)/2);var p=Math.floor((x-w)/2);var t=u.top-p;var r=u.left-s;if(u.top+x>canvasHeight){t=navPos-x-8}if(u.left+o>canvasWidth){r=canvasWidth-o-10}bringToFront(y);var v=function(z){$caption=z.find(".caption");$img=z.find(".gallery-item");$caption.width($img.width()).slideDown();y.data("expanded",true)};e=new TweenMax.to(y,0.25,{width:o,height:x,top:t,left:r,ease:Quad.easeOut,onComplete:v,onCompleteParams:[y]})};var h=function(o){$caption=o.find(".caption");$caption.hide();o.data("expanded",false);e=new TweenMax.to(o,0.25,{width:o.data("width"),height:o.data("height"),top:o.data("top"),left:o.data("left"),ease:Quad.easeOut})};var j=$("<div/>",{"class":"gallery",css:{visibility:"visible"}}).mouseenter(function(){d($(this))}).click(function(){if($(this).data("expanded")==true){h($(this))}else{d($(this))}}).mouseleave(function(){h($(this))});c.load(function(){if(c.width()>c.height()){j.width(g);j.height(c.height()/(c.width()/g))}else{j.height(g);j.width(c.width()/(c.height()/g))}j.css({top:canvasHeight});j.append(c).appendTo($(".story-detail")).append(f);var p=j.position();if(j.width()>j.height()){var r=j.height()-(j.width()/2);j.data({top:m+r})}else{j.data({top:m})}if($(".gallery").length==allData.stories[b].gallery.length){var q=20;var o=new TimelineMax({delay:1.5});$.each($(".gallery"),function(w,s){var u=$(this).position();var t=920;if(w>0){$prev=$(".pic"+(w-1));pos=$prev.position();t=pos.left-$(this).width()-q}else{t=t-$(this).width()}$(this).css({left:t}).addClass("pic"+w);$(this).find(".gallery-item").css("visibility","visible");o.add(TweenMax.to($(this),0.5,{top:$(this).data("top"),ease:Circ.easeOut}),"-=.25");$(this).data({width:$(this).width(),height:$(this).height(),top:$(this).data("top"),left:t})})}}).attr("src",this.img)})}function initialiseTimer(){if(!$(".transition").length){clearInterval(timer);timer=setInterval(function(){changeImage();stopAndRestartTimer()},getRandom(100,3000))}}function stopAndRestartTimer(){initialiseTimer()}function pauseTimer(){clearInterval(timer)}function changeImage(){targetContainer=containerOrder[currContainer];currContainer++;if(currContainer>=containerOrder.length){currContainer=0}var b=$(".story"+targetContainer+" .img-crop");var c=$(".story"+targetContainer+" .content");var a=function(){b.remove();c.remove()};createNewStory(targetContainer,order[storyCount],function(d){TweenMax.to(d,0.5,{left:d.data("left"),top:d.data("top"),ease:Circ.easeOut,onComplete:a})})}function createNewStory(h,e,f){var d=getRandom(0,color.length-1);var b=getRandom(0,allData.stories[e].thumb.length-1);var a=$("<img/>",{"class":"hidden thumb thumb"+e});var c=$("<div/>",{"class":"content content"+maskCount+" bg-"+color[d],data:{color:d}});var g=$("<div/>",{html:"<h2>"+allData.stories[e].title+"</h2><p>"+allData.stories[e].summary+"</p>","class":"cta"});var i=$(".story"+h);a.appendTo(i);i.data({id:e});a.load(function(){var m=new Image();m.src=a.attr("src");a.data({height:m.height,width:m.width});delete m;var l=a.parent();var p=l.width();var q=l.height();var j=0;var o=0;if(l.width()>l.height()){q=Math.floor(a.data("height")*(p/a.data("height")));j=Math.floor(((q-l.height())/2)*-1)}else{p=Math.floor(a.data("width")*(q/a.data("width")));o=Math.floor(((p-l.width())/2)*-1)}var r=j,n=p;switch(getRandom(1,4)){case 1:r=q*-1;n=o;break;case 2:break;case 3:n=o;r=j+q;break;case 4:n=p*-1;break;default:break}var k=$("<div/>",{css:{height:p,width:q,top:r,left:n},data:{height:q,width:p,left:o,top:j},"class":"img-crop crop"+maskCount});k.append(a);g.appendTo(c);i.append(k);i.append(c);increaseCurrentStory();a.removeClass("hidden");f(k)}).attr("src",allData.stories[e].thumb[b].img)}function increaseCurrentStory(){storyCount++;maskCount++;if(storyCount>order.length-1){storyCount=0}}function bringToFront(a){a.css({"z-index":zIndexTop});zIndexTop++}function imageLoaded(){}var imageCache=new function(){var c=this;var b=[];var a=document.location.href.split("/");a.pop();a=a.join("/")+"/";c.push=function(f,e){if(!f.match(/^http/)){f=a+f}var d=new Image();if(b[f]&&e){e(f)}else{if(e){d.onload=e;d.onerror=e}b[f]=d}d.src=f};c.pushArray=function(j,g,f){var d=0;var h=j.length;for(var e=0;e<h;e++){c.push(j[e],function(i){if(g){g(i)}d++;if(d==h){setTimeout(function(){f(i)},1)}})}}};if(!Array.prototype.indexOf){Array.prototype.indexOf=function(d,c){if(c==null){c=0}else{if(c<0){c=Math.max(0,this.length+c)}}for(var b=c,a=this.length;b<a;b++){if(this[b]===d){return b}}return -1}};